<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MapTemplate Viewer</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body, html { margin: 0; height: 100%; }
    #map        { width: 100%; height: 100%; }
    #toolbar    { position:absolute; top:8px; left:8px; z-index:1000; background:#fff; padding:6px 10px; border-radius:4px; box-shadow:0 0 6px #0003;}
    #toolbar input{ width:90px }
    #error      { color:#d00; font-size:0.8rem }
  </style>
</head>
<body>
  <div id="toolbar">
    <div style="margin-bottom: 8px;">
      <select id="templateSelect" style="width: 200px; padding: 4px;">
        <option value="">Loading templates...</option>
      </select>
    <button id="btnLoad">Load</button>
    </div>
    <div style="margin-bottom: 4px;">
      Or Template ID: <input id="templateId" value="" style="width: 60px;" />
    </div>
    <span id="error"></span>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const apiBase = "https://localhost:7099";      // ‚≠ê URL g·ªëc API c·ªßa b·∫°n
    const token   = "eyJhbGciOiJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNobWFjLXNoYTI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTY3NDY1NDAsIm5iZiI6MTc1Njc0Mjk0MCwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvZW1haWxhZGRyZXNzIjoic3RyaW5nQGdtYWlsLmNvbSIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiMDhkZGU5NWUtMjE4MS00YzAzLThiMjItMTY0N2FjOWYxNTc3In0.ddhrKj_f5PfIRtPW-8tZdxX7zxuhsxD6YolHFtcMIf8";         // ‚≠ê Token n·∫øu endpoint c·∫ßn auth

    // kh·ªüi t·∫°o map
    const map = L.map("map").setView([16.0471, 108.2062], 6); // VN center
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    // style polygon m·∫∑c ƒë·ªãnh
    const polygonStyle = {
      color: "#3388ff",
      weight: 2,
      fillColor: "#3388ff",
      fillOpacity: 0.2,
    };

    // ‚úÖ Load all templates on page load
    async function loadTemplateList() {
      try {
        const res = await fetch(`${apiBase}/api/v1/maps/templates`, {
          headers: token ? { Authorization: `Bearer ${token}` } : {}
        });

        if (!res.ok) {
          document.getElementById("templateSelect").innerHTML = 
            '<option value="">‚ùå Error loading templates</option>';
          return;
        }

        const data = await res.json();
        const templates = data.templates || [];
        
        const selectElement = document.getElementById("templateSelect");
        selectElement.innerHTML = '<option value="">-- Select Template --</option>';
        
        templates.forEach(template => {
          const option = document.createElement("option");
          option.value = template.templateId;
          option.textContent = `${template.templateName} (${template.totalFeatures} features)`;
          selectElement.appendChild(option);
        });

        // ‚úÖ Auto-select first template if available
        if (templates.length > 0) {
          selectElement.value = templates[0].templateId;
        }

      } catch (error) {
        console.error("Error loading templates:", error);
        document.getElementById("templateSelect").innerHTML = 
          '<option value="">‚ùå Error loading templates</option>';
      }
    }

    // ‚úÖ Handle template selection change
    document.getElementById("templateSelect").onchange = function() {
      const selectedId = this.value;
      if (selectedId) {
        document.getElementById("templateId").value = selectedId;
      }
    };

    document.getElementById("btnLoad").onclick = async () => {
      const id   = document.getElementById("templateId").value.trim();
      const msg  = document.getElementById("error");
      msg.textContent = "";

      if (!id) { msg.textContent = "Vui l√≤ng nh·∫≠p templateId"; return; }

      try {
        // ---- g·ªçi API: GET /api/v1/api/maps/templates/{templateId}
        const res = await fetch(`${apiBase}/api/v1/maps/templates/${id}`, {
          headers: token ? { Authorization: `Bearer ${token}` } : {}
        });

        if (!res.ok) {
          msg.textContent = `API error ${res.status}`;
          return;
        }
        const data = await res.json();
        console.log("API Response:", data); // Debug log

        // ‚úÖ L·∫•y template t·ª´ response structure m·ªõi
        const template = data.template;
        if (!template) {
          msg.textContent = "Template not found in response";
          return;
        }

        // ‚úÖ Hi·ªÉn th·ªã th√¥ng tin template
        document.title = `MapTemplate Viewer - ${template.templateName}`;
        
        // ‚úÖ Clear layer c≈©
        if (window._allLayers) {
          window._allLayers.forEach(layer => map.removeLayer(layer));
          window._allLayers = [];
        } else {
          window._allLayers = [];
        }

        // ‚úÖ Load v√† hi·ªÉn th·ªã t·ª´ng layer v·ªõi GeoJSON data th·ª±c t·∫ø
        if (template.layers && template.layers.length > 0) {
          let layersLoaded = 0;
          const totalLayers = template.layers.length;
          
          msg.textContent = `Loading ${totalLayers} layers...`;
          
          for (const layerInfo of template.layers) {
            try {
              // G·ªçi API ƒë·ªÉ l·∫•y layer data
              const layerRes = await fetch(`${apiBase}/api/v1/maps/templates/${template.templateId}/layers/${layerInfo.layerId}/data`, {
                headers: token ? { Authorization: `Bearer ${token}` } : {}
              });

              if (layerRes.ok) {
                const layerData = await layerRes.json();
                const geoJsonData = JSON.parse(layerData.layerData);

                // ‚úÖ Parse layer style n·∫øu c√≥
                let layerStyle = polygonStyle;
                if (layerInfo.layerStyle) {
                  try {
                    const customStyle = JSON.parse(layerInfo.layerStyle);
                    layerStyle = { ...polygonStyle, ...customStyle };
                  } catch (e) {
                    console.warn("Invalid layer style, using default:", e);
                  }
                }

                // ‚úÖ T·∫°o layer v·ªõi data th·ª±c t·∫ø
                const geoLayer = L.geoJSON(geoJsonData, {
                  style: layerStyle,
                  onEachFeature: function(feature, layer) {
                    // Th√™m popup v·ªõi th√¥ng tin feature
                    if (feature.properties) {
                      const popupContent = Object.entries(feature.properties)
                        .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                        .join('<br/>');
                      layer.bindPopup(`
                        <div style="max-width: 300px;">
                          <h4>${layerInfo.layerName}</h4>
                          ${popupContent}
                        </div>
                      `);
                    }
                  }
                }).addTo(map);

                window._allLayers.push(geoLayer);
                layersLoaded++;

                // ‚úÖ Fit bounds khi load layer ƒë·∫ßu ti√™n
                if (layersLoaded === 1) {
                  map.fitBounds(geoLayer.getBounds());
                }

                console.log(`‚úÖ Loaded layer: ${layerInfo.layerName} (${layerInfo.featureCount} features)`);
              } else {
                console.warn(`‚ùå Failed to load layer ${layerInfo.layerId}:`, layerRes.status);
              }
            } catch (e) {
              console.error(`‚ùå Error loading layer ${layerInfo.layerId}:`, e);
            }
          }

          msg.style.color = "#28a745";
          msg.textContent = `‚úÖ Loaded: ${template.templateName} (${layersLoaded}/${totalLayers} layers, ${template.totalFeatures} features)`;
        } else {
          // ‚úÖ Fallback: Hi·ªÉn th·ªã bounds n·∫øu kh√¥ng c√≥ layers
          if (template.defaultBounds) {
            const boundsGeoJson = JSON.parse(template.defaultBounds);
            const boundsLayer = L.geoJSON(boundsGeoJson, { style: polygonStyle }).addTo(map);
            window._allLayers.push(boundsLayer);
            map.fitBounds(boundsLayer.getBounds());
            
            msg.style.color = "#ffc107";
            msg.textContent = `‚ö†Ô∏è No layers found, showing bounds only`;
          } else {
            msg.textContent = "No map data available";
            return;
          }
        }

        // ‚úÖ Hi·ªÉn th·ªã popup v·ªõi th√¥ng tin template (sau khi ƒë√£ load layers)
        if (window._allLayers.length > 0) {
          const center = map.getCenter();
          L.popup()
            .setLatLng(center)
            .setContent(`
              <div style="min-width: 200px;">
                <h4 style="margin: 0 0 8px 0;">${template.templateName}</h4>
                <p style="margin: 4px 0; color: #666;">${template.description || 'No description'}</p>
                <div style="font-size: 0.9em; color: #007bff;">
                  <strong>üìä Stats:</strong><br/>
                  ‚Ä¢ ${template.totalLayers} layers<br/>
                  ‚Ä¢ ${template.totalFeatures} features<br/>
                  ‚Ä¢ Category: ${template.category}<br/>
                  ‚Ä¢ Created: ${new Date(template.createdAt).toLocaleDateString()}
                </div>
                ${template.layers ? `
                  <div style="margin-top: 8px; font-size: 0.85em;">
                    <strong>üó∫Ô∏è Layers:</strong><br/>
                    ${template.layers.map(layer => 
                      `‚Ä¢ ${layer.layerName} (${layer.featureCount || 0} features)`
                    ).join('<br/>')}
                  </div>
                ` : ''}
              </div>
            `)
            .openOn(map);
        }

      } catch (e) {
        console.error("Error:", e);
        msg.textContent = `Error: ${e.message}`;
      }
    };

    // ‚úÖ Load templates when page loads
    window.onload = function() {
      loadTemplateList();
    };
  </script>
</body>
</html>